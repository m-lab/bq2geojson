<!DOCTYPE html>

<html>

<head>
	<meta charset='utf-8' />
	<title>Thailand Broadband Map</title>
	<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
	<link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.6/mapbox.css' rel='stylesheet' />
        <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<link href='css/ndt_d3.css' rel='stylesheet' />
	<link href="css/jquery-ui-slider-pips.css" rel="stylesheet" />
	<link href='css/jquery-ui.min.css' rel='stylesheet' />
	<link href='css/mlab.css' rel='stylesheet' />
	<script src='//api.tiles.mapbox.com/mapbox.js/v2.1.6/mapbox.js'></script>
	<script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
	<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
	<script src='js/mlab.js'></script>
	<script src='js/ndt.js'></script>
	<script src='js/ndt_d3.js'></script>
	<script src='js/d3.v3.min.js'></script>
	<script src='js/center.js'></script>
	<script src="js/jquery-ui.min.js"></script>
	<script src="js/jquery-ui-slider-pips.min.js"></script>

</head>

<body>
<div id="spinner">
	<div id="spin">&nbsp;</div>
	<div id="loading">LOADING</div>
</div>
<div id="header">
	<div id="intro">
		<p></p>
		<p>By contributing to this map, you help illustrate how Seattle is progressing toward Mayor’s goal of competitive, equal, and affordable broadband service.</p>

		<p>This test is a measurement of real-world experiences, not your Internet connection itself. The speed you experience can be affected by many things, ranging from the device you’re using, to the time of day, to how many other applications you are running. What you will see is an accurate representation of your Internet speed at the time of each test. You may repeat it as often as you like from different locations and types of connections. The more information about your experience you provide, the better we'll be able to understand current broadband service levels, and plan for the future.</p>

		<p>The software for this map has been developed by the <a href="http://newamerica.org/oti">Open Technology Institute at New America</a> in partnership with the City of Seattle, using open source tools from <a href="http://measurementlab.net">Measurement Lab (M-Lab)</a>. To learn more about how this works and why we’re doing it, as well as how the data we collect will be used and protected, please see the <a href="http://www.seattle.gov/broadband/broadband-map-faq">About the Broadband Speed test page</a>.</p>

		<div id="button-container">
		  <button id="testSpeed" class="btn btn-primary btn-lg">Test my speed<img src="images/speed-light.svg" id="test-icon-sm" alt="Click here to run the M-Lab speed test" title="Click here to run the M-Lab speed test" /></button><br />
		  <button id="exploreMap" class="btn btn-primary btn-sm">No thanks, just show me the map</button>
		</div>
		<p class="disclaimer">Please be aware that the results of the Seattle Broadband Map speed test may vary due to factors other than the actual speed of your internet connection. The device you’re using, operating system, browser, time of day, whether you’re using WiFi or a wired connection, whether you have another process like email or a video running at the same time – all of these and more may significantly alter your results from test to test. The results of the speed test are an accurate representation of your internet connect at the time of each test, and provide a valuable contribution to the overall picture of how Seattle is progressing towards the Mayor’s goal of competitive, equal, and affordable broadband service that approaches a rapidly evolving gigabit standard. Send your questions or comments to <a href="mailto:broadband.map@seattle.gov">broadband.map@seattle.gov</a>.</p>
	</div>
</div>

<div id="sidebar">
	<div id="icons">
		<img src="images/speed.svg" id="test-icon" alt="Click here to run the M-Lab speed test" title="Click here to run the M-Lab speed test" />
		<img src="images/about.svg" id="about-icon" alt="Click here to show more information about this test and M-Lab" title="Click here to show more information about this test and M-Lab" />
	</div>
	<div id="about-ndt">
		<h3 class="league-gothic">About this Map</h3>
		<p>M-Lab data is combined with speed tests contributed from this website provide a picture of Seattle's broadband experience over time. The more data that is contributed, the more accurate the map will become.</p>
		<p>The speed test data you submit here is submitted to M-Lab, is aggregated to assure that it remains anonymous before it’s made publicly available on data.seattle.gov and conforms to <a href="http://seattle.gov/privacy" target="_blank">the City of Seattle’s Privacy Policy</a> and <a href="http://www.measurementlab.net/privacy" target="_blank">M-Lab's Privacy and Acceptable Use Policies</a>. The Seattle Broadband Map application optionally requests your location and after the speed test asks for additional information about your connection to better understand the state of consumer broadband in the city. This additional information is not sent to M-Lab, but is stored in a private database used by this site.</p>
	</div>
	<div id="ndt" class="ndt-related">
		<h3 class="league-gothic">Test your speed!</h3>
		<div id="ndt-div">
			<div id="ndt-svg"></div>
		</div>
		<h4>You can contribute to this map!</h4>
		<p>To start, simply hit the button and answer the questions at the end. All data is kept anonymous and used to improve the state of Seattle’s broadband.</p>
		<div id="approx-loc">
		</div>
		<div id="ndt-status"></div>
	</div>

	<div id="ndt-results" class="ndt-related">
		<h3 class="league-gothic">Your test results:</h3>
		<p>Download speed: <span id="s2cRate"></span>Mbps</p>
		<p>Upload speed: <span id="c2sRate"></span>Mbps</p>
		<p>Minimum Round Trip Time: <span id="MinRTT"></span>ms</p>
	</div>
	<div id="extra-data" class="ndt-related">
		<h4>Thank you for contributing to the Seattle Broadband Speed Test!</h4>
		<h4>Please tell us more (anonymously) about your Internet connection, including who your service provider is, so we can use your speed test results to improve broadband access in Seattle.</h4>
		<form action="/collector/collect" method="post" id="collector">
			<p>Location:
			<select name="location_type" class="form-control">
				<option value="default">------</option>
				<option value="residence">Residence</option>
				<option value="workplace">Workplace</option>
				<option value="business">Business</option>
				<option value="public">Public space</option>
			</select></p>
			<p>What Type of Connection?
			<select name="connection_type" class="form-control">
				<option value="default">------</option>
				<option value="cable">Cable</option>
				<option value="dsl">DSL</option>
				<option value="fiber">Fiber</option>
				<option value="cellular">Cellular</option>
				<option value="other">Other</option>
			</select></p>
			<p>Advertised download speed? <input name="advertised_download" size="3"/><small>Mbps</small></p>
			<p>Advertised upload speed? <input name="advertised_upload" size="3"/><small>Mbps</small></p>
			<p>Monthly cost of service: $ <input name="cost_of_service" size="3" /></p>
			<input name="latitude" id="latitude" type="hidden" />
			<input name="longitude" id="longitude" type="hidden" />
			<input name="actual_download" id="actual_download" type="hidden" />
			<input name="actual_upload" id="actual_upload" type="hidden" />
			<input name="min_rtt" id="min_rtt" type="hidden" />
			<input name="bigquery_key" id="bigquery_key" type="hidden" />
			<input class="btn btn-primary btn-sm" type="submit" value="Send"/>
		</form>
	</div>


	<script>
		var ndtServer,
			ndtPort = "3001",
  			ndtPath = "/ndt_protocol",
  			ndtUpdateInterval = 1000,
			c2sRate,
			s2cRate,
			MinRTT;

		getNdtServer();

		NDT_meter = new NDTmeter('#ndt-svg');
		NDT_meter.meter.on("click", function () {
			NDT_client = new NDTjs(ndtServer, ndtPort, ndtPath, NDT_meter, ndtUpdateInterval);
			NDT_client.startTest();
		});

		if ("geolocation" in navigator) {
			navigator.geolocation.getCurrentPosition(success, error);
		}

		function success(position) {
			document.getElementById('latitude').value = position.coords.latitude;
			document.getElementById('longitude').value = position.coords.longitude;

			var xhr = new XMLHttpRequest(),
			currentLocationURL = "http://nominatim.openstreetmap.org/reverse?format=json&lat=" + position.coords.latitude + "&lon=" + position.coords.longitude + "&zoom=18&addressdetails=1";

			var currentLoc;
			xhr.open('GET', currentLocationURL, true);
			xhr.send();
			xhr.onreadystatechange = function () {
				if (xhr.readyState === 4) {
					if (xhr.status === 200) {
						currentLoc = JSON.parse(xhr.responseText);
						console.log("Location received");

						// currentLocText.text(currentLoc.address.road + currentLoc.address.neighbourhood + currentLoc.address.suburb + currentLoc.address.city + currentLoc.address.state);
						$('#mobile-container').append('<div id="mobile-approx-loc"></div>')
						$('#approx-loc, #mobile-approx-loc').append("<p>Searching from:</p><p>" + currentLoc.address.road + ", " + currentLoc.address.city + ", " + currentLoc.address.state + "</p>");
					} else {
						console.log('Location lookup failed');
					}
				}
			};
		}

		function error(error) {
			document.getElementById('msg').innerHTML = 'ERROR(' + error.code + '): ' + error.message;
		}

		function getNdtServer () {
			var xhr = new XMLHttpRequest(),
				mlabNsUrl = 'http://mlab-ns.appspot.com/ndt?format=json';

			xhr.open('GET', mlabNsUrl, true);
			xhr.send();
			xhr.onreadystatechange = function () {
				if (xhr.readyState === 4) {
					if (xhr.status === 200) {
						ndtServer = JSON.parse(xhr.responseText).fqdn;
						console.log('Using M-Lab Server ' + ndtServer);
					} else {
						console.log('M-Lab NS lookup failed.');
					}
				}
			};
		};

		$('#collector :submit').click(function(e) {
			e.preventDefault();
			var xhr = new XMLHttpRequest(),
				collectorUrl = '/collector/collect?';

			collectorUrl = collectorUrl + $('#collector').serialize();

			xhr.open('GET', collectorUrl, true);
			xhr.send();
			xhr.onreadystatechange = function () {
				if (xhr.readyState === 4) {
					if (xhr.status === 201) {
						console.log('Record successfully added.');
						$('#ndt-results').append("<h3 class='league-gothic'>Thank you for submitting your test!</h3>");
						$('#extra-data').css('display', 'none');
						setTimeout(window.location.assign("thankyou.html"),7000000);

					} else {
						console.log('Failed to create record: ' + xhr.responseText);
						if ($('#extra-data p:last-child').text() != "Please complete the form before submitting.") {
							$('#extra-data').append("<p style='color:red'>Please complete the form before submitting.</p>");
						}
					}
				}
			};
		});

	</script>
</div>

<div id='map'></div>

<script>

// If set to 'hex' then GeoJSON files are assumed to be named like
// 'YYYY_MM-<resolution>.json', where 3 files exist for each of resolutions
// 'low', 'medium', 'high'.  If anything other than 'hex', then this value is
// the MMMM_YY- suffix to look for. For example:
// If set to 'city_council_districts', then the system will look for
// GeoJSON files like 'MMMM_YY-city_council_districts.geojson'.
var polygonType = 'thailand_provinces';

// Either 'topojson' or 'geojson'.  The Node.js script creates both TopoJSON and
// GeoJSON files.  TopoJSON files are significantly smaller in size, but need to
// be converted to GeoJSON by the browser.  There may be some balance between
// loading a smaller file across the network and the processing time on the
// client-side to convert the TopJSON to GeoJSON.  I would conjecture that
// the network is the most limiting factor and that generally TopoJSON will be
// the right choice.  TODO: prove this theory.
var jsonType = "geojson";


// The minimum number of data points in any given polygon for a it to be
// considered statistically relevant.  These cells will either not be displayed
// or will be displayed with a different styling.
var minDataPoints = 5;

// Defines how each overlay is treated on load.  If an overlay is enabled, then
// there will be a checkbox for it in the layers control. 'defaultOn' determines
// whether it will be displayed by default. NOTE: If only a single overlay is
// enabled, then no checkbox will be displayed, since it doesn't make much sense
// to disable the only meaningful layer that exists.
var overlays = {
	'polygon': {
		'enabled': true,
		'defaultOn': true
	},
	'plot': {
		'enabled': false,
		'defaultOn': false
	}
};

// Defines the layers that are going to be added to the map.
var geoLayers = {
	'thailand_provinces': {
		'name': 'Provinces',
		'polygonFile': 'THA_adm3.json',
		'dataUrl': 'stats/q/by_thai_province?format=json&stats=AverageRTT,DownloadCount,MedianDownload,AverageDownload,UploadCount,MedianUpload,AverageUpload&b.spatial_join=key&b.time_slices=month&f.time_slices=',
		'dbKey': 'geoid10',
		'geoKey': 'GEOID10',
		'cache': null,
		'layer': null
	}
};

// Which of the geoLayers should be the one added to the map by default
var defaultLayer = 'census_block_groups';

// If set to true, then prefetch the GeoJSON files into a local cache.  WARNING:
// You may not want to enable if you expect mobile, low bandwidth, or otherwise
// bandwidth restricted users, as this can pull in many megabytes of data.
var seedCache = false;

// The inteval (in milliseconds) to use when animating the map.
var animateInterval = 1500;

// Center and zoom level of map.  center may be pulled in via js/center.js, but
// if not then just set it to the center of the USA.
if ( typeof center == 'undefined' ) {
	var center = [13.3298928,96.6992677]; //
}
var zoom = 6;

// These are the labels that will be used for the month slider in the control
// box in the lower left corner.
var monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct',
	'Nov','Dec'];

// An object which will hold cached GeoJSON files so that we don't have to fetch
// them from the server more than once.  This could potentially be problematic
// if there are many files and they are large.
var geoJsonCache = {};
var geometryCache = null;

// The oldest year and month for which we have data.
var startYear = 2014;
var startMonth = 1;

// Get current year/month into variables
var currentYear = new Date().getFullYear();
var currentMonth = new Date().getMonth() + 1;
// Zero pad the front of the month
currentMonth = currentMonth < 10 ? '0' + currentMonth : currentMonth;

// Be sure that we actually have data for the current month.  If not, then fall
// back to the previous month.
var start = Date.UTC(currentYear, currentMonth - 1, 1) / 1000;
var end = Math.floor(Date.now() / 1000);
var dataUrl = geoLayers[defaultLayer]['dataUrl'] + start + ',' + end;
$.ajax({
	url: dataUrl,
	dataType: 'json',
	async: false,
	success: function(resp) {
		if ( ! resp.features.length ) {
			if ( currentMonth == '01' ) {
				currentMonth = 12;
				currentYear = currentYear - 1;
			} else {
				currentMonth = currentMonth - 1;
				currentMonth = currentMonth < 10 ?
					'0' + currentMonth : currentMonth;
			}
			console.log("No data for current year/month, using last" +
				" month instead.");
		}
	}
});

// An object with the years and months we have data for.  This will be used to
// auto-generate various form controls.
var dates = {};
var thisYear = startYear;
while (thisYear <= currentYear) {
	if (thisYear == currentYear) {
		var months = [];
		for (i = 1; i <= currentMonth; i++) { months.push(i) };
		dates[thisYear] = months
	} else {
		dates[thisYear] = ['1','2','3','4','5','6','7','8','9','10','11','12'];
	}
	thisYear++;
}

// Create the map
var map = L.map('map', {zoomControl: false}).setView(center, zoom);
map.scrollWheelZoom.disable();
var control = L.control.zoom({position: 'topright'});
map.addControl(control);
var osmLayer = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
	attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a>' +
		'contributors'
});

var mapboxLayer = L.tileLayer(
		'https://{s}.tiles.mapbox.com/v3/newamerica.lcl1jan5/{z}/{x}/{y}.png', {
	attribution: '&copy; <a href="http://mapbox.com/">Mapbox</a>'
});

// Set the default base tile layer
map.addLayer(mapboxLayer);

// Add other base tile layer providers as needed
var baseLayers = {
	 'Mapbox': mapboxLayer
};

var layerCtrl = L.control.layers(baseLayers, null, { collapsed: false, position: 'bottomleft' });
addControls();
layerCtrl.addTo(map);
addLegend();

for (var geoLayer in geoLayers) {
	setupLayer(geoLayer);
}

</script>

</body>

</html>
