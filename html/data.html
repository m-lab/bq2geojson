<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='utf-8'>
  <meta content='width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0' name='viewport'>

  <title>Seattle Broadband Quality</title>

  <script src='js/bootstrap.min.js' type='text/javascript'></script>
  <script src='js/crossfilter.js' type='text/javascript'></script>
  <script src='js/d3.v3.min.js' type='text/javascript'></script>
  <script src='js/dc.js' type='text/javascript'></script>
  <script src='js/jquery-1.9.1.min.js' type='text/javascript'></script>

  <link href='css/bootstrap.min.css' rel='stylesheet' type='text/css'>
  <link href='css/dc.css' rel='stylesheet' type='text/css'>

  <style type="text/css"></style>
</head>

<body>

<div class='container' id='main-container'>
<div class='content'>
<div class='container' style='font: 12px sans-serif;'>

  <div class='row'>
    <div class='span12'>
      <h2>Seattle Broadband Quality</h2>
      <div class='row'>
        <h3>
        <div class="pie-graph span4">
        <span id='dc-total-count'></span> tests
        </div>

        <div class="pie-graph span4">
        Median Download:<br /><span id='dc-total-count2'></span> Mbps
        </div>

        <div class="pie-graph span4">
        Median Upload:<br /><span id='dc-total-count3'></span> Mbps
        </div>
        </h3>
      </div>

      <div class='row'>
        <div class='pie-graph span6' id='dc-magnitude-chart'>
        <h4>Tests by Median Download</h4>
        </div>
        <div class='pie-graph span6' id='dc-depth-chart'>
	      <h4>Tests by Upload Median</h4>
        </div>    
      </div>
    </div>
  </div>

  <div class='row'>
    <div class='span12' id='dc-time-chart'>
      <h4>Tests per day</h4>
    </div>
  </div>

  <div class='row'>
	<div class='pie-graph span12'>
      <table class='table table-hover' id='dc-table-graph'>
        <thead>
          <tr class='header'>
            <th>Time/Date</th>
            <th>Download</th>
            <th>Upload</th>
            <th>RTT</th>
            <th>ISP</th>
          </tr>
        </thead>
      </table>
	</div>
  </div>


<h6>Generated with 
  <a href="http://nickqizhu.github.io/dc.js/">dc.js</a>,
  <a href="http://square.github.io/crossfilter/">crossfilter</a>, 
  <a href="http://d3js.org/">d3.js</a> and 
  <a href="http://twitter.github.io/bootstrap/">bootstrap</a>.
</h6>

</div>
</div>
</div>
  
<script>
  
/**********************************
* Step0: Load data from json file *
**********************************/

// load data from a csv file
d3.csv("data/chartdata.csv", function (data) {

  // format our data
  var dtgFormat = d3.time.format("%Y-%m-%dT%H:%M:%S");
  
  data.forEach(function(d) { 
    d.time_slice   = new Date(d.time_slice*1000); 
    //d.lat   = +d.latitude;
    //d.long  = +d.longitude;
    d.download_median   = +d.download_median;
    d.upload_median   = +d.upload_median;
    d.rtt_avg   = +d.rtt_avg;
    d.isp   = d.isp;
    //d.magnitude = d3.round(+d.magnitude,1);
    //d.depth = d3.round(+d.depth,0);
  });

/******************************************************
* Step1: Create the dc.js chart objects & ling to div *
******************************************************/

  var magnitudeChart = dc.barChart("#dc-magnitude-chart"); //download
  var depthChart = dc.barChart("#dc-depth-chart"); //rtt
  var timeChart = dc.lineChart("#dc-time-chart"); //test volume
  var dataTable = dc.dataTable("#dc-table-graph");

/****************************************
* 	Run the data through crossfilter    *
****************************************/

  var facts = crossfilter(data);  // Gets our 'facts' into crossfilter
  var total = facts.groupAll().reduceCount().value();
  $('#dc-total-count').text(total);

  var oMedianDL = facts.groupAll().reduceSum(function(d){ return d.download_median; }).value()/total;
  $('#dc-total-count2').text(Math.round(oMedianDL));

  var oMedianUL = facts.groupAll().reduceSum(function(d){ return d.upload_median; }).value()/total;
  $('#dc-total-count3').text(Math.round(oMedianUL));

/******************************************************
* Create the Dimensions                               *
* A dimension is something to group or filter by.     *
* Crossfilter can filter by exact value, or by range. *
******************************************************/

  // for Magnitude
  var magValue = facts.dimension(function (d) {
    return d.download_median;       // group or filter by magnitude
  });
  var magValueGroupSum = magValue.group()
    .reduceSum(function(d) { return d.download_median; });	// sums the magnitudes per magnitude
  var magValueGroupCount = magValue.group()
    .reduceCount(function(d) { return d.download_median; }) // counts the number of the facts by magnitude

  var magValueGroupCount3 = magValue.group().reduceCount(function(d){ return d.isp; });
  console.log(magValueGroupCount3.top(5));

//upload
  var magValue2 = facts.dimension(function (d) {
    return d.upload_median;       // group or filter by magnitude
  });
  var magValueGroupSum2 = magValue2.group()
    .reduceSum(function(d) { return d.upload_median; });  // sums the magnitudes per magnitude
  var magValueGroupCount2 = magValue2.group()
    .reduceCount(function(d) { return d.upload_median; }) // counts the number of the facts by magnitude


  // For datatable
  var timeDimension = facts.dimension(function (d) {
    return d.time_slice;
  }); // group or filter by time

  // for Depth
  var depthValue = facts.dimension(function (d) {
    return d.rtt_avg;
  });
  var depthValueGroup = depthValue.group();

  var depthValueGroupSum = depthValue.group()
    .reduceSum(function(d) { return d.rtt_avg; });  // sums the magnitudes per magnitude
  var depthValueGroupCount = depthValue.group()
    .reduceCount(function(d) { return d.rtt_avg; }) // counts the number of the facts by magnitude

  
  // define a daily volume Dimension
  var volumeByDay = facts.dimension(function(d) {
    return d.time_slice;
    //return d3.time.hour(d.time_slice);
  });

  // map/reduce to group sum
  var volumeByDayGroup = volumeByDay.group()
    .reduceCount(function(d) { return d.time_slice; });

    var medianDLByDayGroup = volumeByDay.group()
    .reduceCount(function(d) { return d.download_median; });

    //by isp
    var ispValue = facts.dimension(function(d){
      return d.isp;
    });

    var ispValueGroup = ispValue.group()
      .reduceCount(function(d){ return d.isp;});
    //console.log(ispValueGroup);

/***************************************
* 	Step4: Create the Visualisations   *
***************************************/
  
  // Magnitide Bar Graph Summed
  magnitudeChart.width(480)
    .height(150)
    .margins({top: 10, right: 10, bottom: 20, left: 40})
    .dimension(magValue)								// the values across the x axis
    .group(magValueGroupSum)							// the values on the y axis
	.transitionDuration(500)
    .centerBar(true)	
	.gap(10)                                            // bar width Keep increasing to get right then back off.
    .x(d3.scale.linear().domain([0, 1000]))
	.elasticY(true)
	.xAxis().tickFormat(function(v) {return v;});	

  // Depth bar graph
  depthChart.width(480)
    .height(150)
    .margins({top: 10, right: 10, bottom: 20, left: 40})
    .dimension(magValue2)
    .group(magValueGroupSum2)
	.transitionDuration(500)
    .centerBar(true)	
	.gap(10)                    // bar width Keep increasing to get right then back off.
    .x(d3.scale.linear().domain([0, 1000]))
	.elasticY(true)
	.xAxis().tickFormat(function(v) {return v;});

  // time graph
  timeChart.width(960)
    .height(100)
    .margins({top: 10, right: 10, bottom: 20, left: 40})
    .dimension(volumeByDay)
    .group(volumeByDayGroup)
    .transitionDuration(500)
	.elasticY(true)
    .x(d3.time.scale().domain([new Date(2013, 12, 01), new Date(2015, 12, 31)])) // scale and domain of the graph
    //.x(d3.scale.linear().domain([d3.min(data, function(d){ return d.time_slice;}), d3.max(data, function(d) { return d.time_slice; })]))
    .xAxis();

  // Table of earthquake data
  dataTable.width(960).height(800)
    .dimension(ispValue)
	.group(function(d) { return "List of all tests corresponding to the filters" })
  //.group()
	.size(total)							// number of rows to return
    .columns([
      function(d) { return d.time_slice; },
      function(d) { return d.download_median; },
      function(d) { return d.upload_median; },
      function(d) { return d.rtt_avg; },
      function(d) { return d.isp; }
    ])
    .sortBy(function(d){ return d.time_slice; })
    .order(d3.ascending);

/****************************
* Step6: Render the Charts  *
****************************/
			
  dc.renderAll();
  
});
  
</script>
    
</body>
</html>
